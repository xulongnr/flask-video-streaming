<html>
  <head>
    <title>GPhoto Demo</title>
  </head>
  <body>
    <h1 onClick='onEnableLV()'>GP Demo</h1>

    <h2>Live View
    <input disabled='1' id='btnLv' type=button value='开启' onclick="onSwitchLiveview();" title='关闭需要等待10秒钟'>
    </h2>
    <!-- <img id='imgLv' src="{{ url_for('live_view') }}" style="border:1px;width:528px;height:352px"> -->
    <img id='imgLv' src='' style="border:1px;width:528px;height:352px;display:none">
    <hr>

    <h2>Preview Capture
    <input id='btnPv' type=button value='开启' onclick="onSwitchPreview();">
    </h2>
    <!-- <img id='imgPv' src="{{ url_for('capture_preview') }}?" style="border:1px;width:528px;height:352px"> -->
    <img id='imgPv' src='' style="border:1px;width:528px;height:352px;display:none">
    <hr>

    <h2>Image Capture
    <input id='btnIv' type=button value='开启' onclick="onSwitchImage();">
    <input disabled='1' id='btnEi' type=button value='获取EXIF' onclick="onGetExif();">
    <input style="display: none" id='btnEh' type=button value='隐藏EXIF' onClick="onHideExif();">
    </h2>
    <!-- <img id='imgIv' src="{{ url_for('capture_image') }}?" style="border:1px;width:1728px;height:1152px> -->
    <textarea id='taIv' rows='24' readonly style='width:70%;display:none;margin-bottom:10px'></textarea>
    <!--<img id='imgIv' src='' style="border:1px;width:1728px;height:1152px;display:none">-->
    <img id='imgIv' src='' style="border:1px;width:100%;display:none">
    <hr>

    <h2>Time Lapse
    <input id='btnTlStart' type=button value='开始' onclick='onStartTimeLapse()'>
    <input id='btnTlStop'  type=button value='停止' onclick='onStopTimeLapse()' disabled="1">
    <label style="font-size: small; margin-left: 20px">间隔(秒)：</label>
    <input id='txtIntVal' type="text" name="interval" value="60" style="width: 50px">
    <label style="font-size: small; margin-left: 20px">等待(秒)：</label>
    <label style="font-size: small" id='txtToWait' />
    </h2>
    <table id='tableTimeLapses' style='font-size: small'>

    </table>
    <hr>

    <h2>Camera Configures
    <input id='btnCc' type=button value='获取' onclick="onGetCameraConfigs();">
    <input id='btnCh' type=button value='隐藏' onclick="onHideCameraConfigs();" style='display:none'>
    </h2>

    <table id='tableConfigs' style='font-size: small'>
    <tr>
        <td>ISO</td>
        <td></td>
        <td><select id='cfgISO' style='width:80px' onChange='onChangeISO()'></select></td>
        <td></td>
        <td id='stISO'></td>
    </tr>
    <tr>
        <td>快门</td>
        <td></td>
        <td><select id='cfgShs' style='width:80px' onChange='onChangeShs()'></select></td>
        <td></td>
        <td id='stShs'></td>
    </tr>
    <tr>
        <td>光圈</td>
        <td></td>
        <td><select id='cfgApt' style='width:80px' onChange='onChangeApt()'></select></td>
        <td></td>
        <td id='stApt'></td>
    </tr>
    </table>
    <textarea id='taCfg' rows='70' readonly style='width:70%;display:none;margin-top:10px'></textarea>
  </body>

  <!-- <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script> -->
  <!-- <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/3.5.1/jquery.min.js"></script> -->
  <script type="text/javascript" src="http://cdn.bootcss.com/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript">

	var bLvOn = false;
	var bPvOn = false;
	var bIvOn = false;
    var bLvDs = true;
	var urlPrefix = window.location.protocol + '//' +window.location.host + '/api';
	var urlLv = urlPrefix + '/live_view?';
	var urlPv = urlPrefix + '/capture_preview_q?';
	var urlIv = urlPrefix + '/capture_image_q?';
    var urlTl = urlPrefix + '/capture_image_and_download';
    var urlTb = urlPrefix + '/thumbnail/';
    var urlIg = urlPrefix + '/image/';
    var urlExif = urlPrefix + '/exif_image';
	var urlCfgs = urlPrefix + '/configs_q';
	var urlCfg = urlPrefix + '/config_q';
    var urlStI = urlPrefix + '/storage_info';
	var config = null;

	function sleep(time) {
	    var startTime = new Date().getTime() + parseInt(time, 10);
	    while (new Date().getTime() < startTime) {}
	};

	function onSwitchPreview() {

		if (!bPvOn) {
			bPvOn = true;
			bIvOn = false;
			bLvOn = false;
			$(imgIv).css({display: 'none'});
			$(imgPv).css({display: 'block'});
			$(imgPv).attr('src', urlPv);
			$(imgIv).attr('src', '');
			$(btnPv).attr('value', '刷新');
			$(btnIv).attr('value', '开启');
            $(btnEi).attr('disabled', 'disabled');
            $(taIv).hide();
            $(btnEh).hide();

		} else {
			// refresh
			$(imgPv).attr('src', $(imgPv).attr('src').split('?')[0]+'?'+Math.random());
		}

	}

    function onEnableLV() {
        bLvDs = !bLvDs;
        if (!bLvDs)
            $(btnLv).removeAttr('disabled');
        else
            $(btnLv).attr('disabled', '1');
    }

	function onHideCameraConfigs() {
		$(taCfg).hide();
		$(btnCh).hide();
	}
	function onGetCameraConfigs() {
		$(taCfg).val('');
		$.get(urlCfgs, function(data, status){
			$(taCfg).val(JSON.stringify(data,null,2));
			$(taCfg).show();
			config = data;
			if (null == config) return;

			initConfigTable(config);
			$(btnCh).show();

		});
	}

	function initConfigTable(config) {
		filters = ['iso', 'shutterspeed', 'aperture', 'exposurecompensation', 'whitebalance', 'autoexposuremode', 'meteringmode', 'picturestyle', 'imageformat', 'aspectratio'];
		desc_cn = ['ISO', '快门', '光圈', '曝光补偿', '白平衡', '曝光模式', '测光模式', '图片风格', '保存格式', '横竖比'];
		_table = $('table#tableConfigs');
		tr_tmpl = "<tr><td/><td/>\
		<td><select name='' style='width:120px' onChange='onChangeSelect(this)'/></td>\
		<td/><td/></tr>";
		$(_table).find('tr').remove();

		$.each(config, (k0, v0) => {
			$.each(v0.items, (k1, v1) => {
				index = $.inArray(v1.name, filters);
				if (-1 != index) {
					$(tr_tmpl).appendTo($(_table));
					_tr = $(_table).find('tr').slice(-1);
					_td = $(_tr).find('td')[0]
					$(_td).append(desc_cn[index]);
					_td = $(_tr).find('td')[1]
					$(_td).append(v1.desc);
					_td = $(_tr).find('td')[2];
					_sel = $(_td).children('select')[0];
					$(_sel).attr('name', v1.name);
					$.each(v1.choices, (k2, v2) => {
						var selected = '';
						if (k2 == v1.choice_index) selected = ' selected';
						$(_sel).append('<option value='+v2+selected+'>'+v2+'</option>');
					});
				}
			});
		});
	}

	function onChangeSelect(obj) {
		name = obj.name;
		value = obj.options[obj.options.selectedIndex].value;
		console.debug('name:', name, 'value:', value);
		if ('' == value || '' == name) return;
		$.ajax({
			url: urlCfg,
			type: 'PUT',
			contentType: 'application/json',
			data: JSON.stringify({name: name, value: value}),
			success: (data, status) => {
				_td = $(obj).parent().parent().children('td')[4]
				$(_td).empty().append(status+', ').append(JSON.stringify(data));
			}
		});
	}

	function onChangeISO() {
		value = $(cfgISO).val();
		if ('' != value) {
			$.ajax({
				url: urlCfg,
				type: 'PUT',
				contentType: 'application/json',
				data: JSON.stringify({name: 'iso', value: value}),
				success: function(data, status) {
					$(stISO).empty();
					$(stISO).append(status+', ');
					$(stISO).append(JSON.stringify(data));
				}
			});
		}
	}

	function onChangeApt() {
		value = $(cfgApt).val();
		if ('' != value) {
			$.ajax({
				url: urlCfg,
				type: 'PUT',
				contentType: 'application/json',
				data: JSON.stringify({name: 'aperture', value: value}),
				success: function(data, status) {
					$(stApt).empty();
					$(stApt).append(status+', ');
					$(stApt).append(JSON.stringify(data));
				}
			});
		}
	}

	function onChangeShs() {
		value = $(cfgShs).val();
		if ('' != value) {
			$.ajax({
				url: urlCfg,
				type: 'PUT',
				contentType: 'application/json',
				data: JSON.stringify({name: 'shutterspeed', value: value}),
				success: function(data, status) {
					$(stShs).empty();
					$(stShs).append(status+', ');
					$(stShs).append(JSON.stringify(data));
				}
			});
		}
	}

	function onHideExif() {
		$(taIv).hide();
		$(btnEh).hide();
	}
	function onGetExif() {
		//$(taIv).hide();
		$(taIv).val('');
		$.get(urlExif, function(data, status){
			console.debug(status);
			$(taIv).val(JSON.stringify(data,null,2));
			$(taIv).show();
			$(btnEh).show();
		});
	}
	function updateDelay() {
		//sleep(1000);
		$(btnIv).attr('value', '刷新');
	}
	function onSwitchImage() {
		if (!bIvOn) {
			bIvOn = true;
			bPvOn = false;
			bLvOn = false;
			$(imgPv).css({display: 'none'});
			$(imgIv).css({display: 'block'});
			$(btnEi).removeAttr('disabled');
			$(imgIv).attr('src', urlIv);
			$(imgPv).attr('src', '');
			$(btnPv).attr('value', '开启');
			$(btnIv).attr('value', '开启中...');
			setTimeout('updateDelay()', 2000);
		} else {
			// refresh
			$(imgIv).attr('src', $(imgIv).attr('src').split('?')[0]+'?'+Math.random());
			$(btnIv).attr('value', '刷新中...');
			$(taIv).hide();
            $(btnEh).hide();
			setTimeout('updateDelay()', 2000);
		}

	}

	function onSwitchLiveview() {
		if (!bLvOn) {
			bLvOn = true;
			bIvOn = false;
			bPvOn = false;
			$(imgPv).css({display: 'none'});
			$(imgIv).css({display: 'none'});
			$(imgLv).css({display: 'block'});
			$(imgIv).attr('src', '');
			$(imgPv).attr('src', '');
			$(imgLv).attr('src', urlLv);
			$(btnPv).attr('disabled', 'disabled');
			$(btnIv).attr('disabled', 'disabled');
			$(btnEi).attr('disabled', 'disabled');
			$(btnCc).attr('disabled', 'disabled');
            $(btnTlStart).attr('disabled', 'disabled');
			$(btnPv).attr('value', '开启');
			$(btnIv).attr('value', '开启');
			$(btnLv).attr('value', '关闭');
			$(taIv).hide();
			$(btnEh).hide();
		} else {
			bLvOn = false;
			$(imgLv).attr('src', '');
			$(btnLv).attr('value', '关闭中...请耐心等待10秒钟');
			$(btnLv).attr('disabled', '1');
			setTimeout('closeLiveView()', 10000);
		}
	}
	function closeLiveView() {
		$.ajax({
			url: urlLv,
			type: "DELETE",
			success: (result) => {
				$(btnLv).removeAttr('disabled');
				$(btnLv).attr('value', '开启');
				$(imgLv).css({display: 'none'});
				$(btnPv).removeAttr('disabled');
				$(btnIv).removeAttr('disabled');
				$(btnCc).removeAttr('disabled');
                $(btnTlStart).removeAttr('disabled');
			}
		})
	}

    count = 0;
    left = 0;
    timer = null;
    alert_low_storage_size = 100000; // 100M low storage alert
    function take_a_shot() {
        $.ajax({
            url: urlTl,
            success: (result) => {
                appendTimeLapseTable(result.filepath, new Date());
            }
        });
    }
    function take_a_check() {
        $.ajax({
            url: urlStI,
            success: (result) => {
                if (result.avail < alert_low_storage_size) {
                    appendAlertCell(result.avail);
                    onStopTimeLapse();
                }
            }
        });
    }

    function countDown() {
        if (left > 0) {
            interval = $(txtIntVal).val();
            if (left == Math.round(interval/2)) {
                take_a_check();
            }
            left--;
            $(txtToWait).html(left);
        } else {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            count++;
            take_a_shot();
            left = $(txtIntVal).val() - 1;
            $(txtToWait).html(left);
            timer = setInterval('countDown()', 1000);
        }
    }

    function appendAlertCell(remain) {
        _table = $('table#tableTimeLapses');
        var num_in_row = 7;
        if (count % num_in_row == 1)
            $(_table).append('<tr>');
        td_str = '<td align=center style="color:red;width:150px">存储空间过低！<br>'
        td_str += '仅剩' + Math.round(remain/1024) + 'MB。<td>'
        $(_table).append(td_str)
        if (count % num_in_row == num_in_row)
            $(_table).append('</tr>');
    }

    function appendTimeLapseTable(image_path, ts = new Date()) {
        _table = $('table#tableTimeLapses');
        img_path_b64 = window.btoa(image_path);
        url_tb = urlTb + img_path_b64 + '?ratio=0.25';
        url_ig = urlIg + img_path_b64;
        var num_in_row = 7;
        if (count % num_in_row == 1)
            $(_table).append('<tr>');
        ts_str = ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString() +
            ' (' + count + ')';
        $(_table).append('<td align=center><a href="' + url_ig + '" target=_blank>' +
                         '<img style="width:150px;height:100px" src="' +
                         url_tb + '"></a><br>' + ts_str + '</td>');
        if (count % num_in_row == num_in_row)
            $(_table).append('</tr>');
    }

    function onStartTimeLapse() {
        _table = $('table#tableTimeLapses');
        $(_table).empty();

        left = $(txtIntVal).val() - 1;
        $(txtToWait).html(left);
        $(txtIntVal).attr('disabled', '1');
        $(btnTlStop).removeAttr('disabled');
        $(btnTlStart).attr('disabled', '1');
        count = 1;
        take_a_shot();
        timer = setInterval('countDown()', 1000);
    }

    function onStopTimeLapse() {
        clearInterval(timer);
        timer = null;
        $(txtIntVal).removeAttr('disabled');
        $(txtToWait).html('');
        $(btnTlStart).removeAttr('disabled');
        $(btnTlStop).attr('disabled', '1');
    }

  </script>
</html>
