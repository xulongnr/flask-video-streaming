<html>
  <head>
    <title>GPhoto Demo</title>
  </head>
  <body>
    <h2>Live View
    <input disabled='1' id='btnLv' type=button value='开启' onclick="onSwitchLiveview();" title='关闭需要等待3秒钟'>
    </h2>
    <!-- <img id='imgLv' src="{{ url_for('live_view') }}" style="border:1px;width:528px;height:352px"> -->
    <img id='imgLv' src='' style="border:1px;width:528px;height:352px;display:none">   
    <hr>

    <h2>Preview Capture
    <input id='btnPv' type=button value='开启' onclick="onSwitchPreview();">
    </h2>
    <!-- <img id='imgPv' src="{{ url_for('capture_preview') }}?" style="border:1px;width:528px;height:352px"> -->
    <img id='imgPv' src='' style="border:1px;width:528px;height:352px;display:none">
    <hr>

    <h2>Image Capture
    <input id='btnIv' type=button value='开启' onclick="onSwitchImage();">
    </h2>
    <!-- <img id='imgIv' src="{{ url_for('capture_image') }}?" style="border:1px;width:1728px;height:1152px> -->
    <img id='imgIv' src='' style="border:1px;width:1728px;height:1152px;display:none">
    <textarea id='taIv' rows='30' readonly style='width:66%;display:none;margin-top:5px'></textarea>
    <hr>
    
  </body>

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script type="text/javascript">
	
	var bLvOn = false;
	var bPvOn = false;
	var bIvOn = false;
	var urlPrefix = window.location.protocol + '//' +window.location.host + '/api';
	var urlLv = urlPrefix + '/live_view?';
	var urlPv = urlPrefix + '/capture_preview?';
	var urlIv = urlPrefix + '/capture_image?';
    var urlExif = urlPrefix + '/exif_image';

	function sleep(time) {
	    var startTime = new Date().getTime() + parseInt(time, 10);
	    while (new Date().getTime() < startTime) {}
	};

	function closeLiveView() {
		$.ajax({
			url: urlLv,
			type: "DELETE",
			success: function(result) {
			}
   		})
	}

	function onSwitchPreview() {
		
		if (!bPvOn) {
			bPvOn = true;
			bIvOn = false;
			bLvOn = false;
			$(imgIv).css({display: 'none'});
			$(imgPv).css({display: 'block'});
			$(imgPv).attr('src', urlPv);
			$(imgIv).attr('src', '');
			$(btnPv).attr('value', '刷新');
			$(btnIv).attr('value', '开启');
            $(taIv).hide();
			
		} else {
			// refresh
			$(imgPv).attr('src', $(imgPv).attr('src').split('?')[0]+'?'+Math.random());
		}
		
	}
	function updateExif() {
		$(taIv).hide();
		$(taIv).val('');
		$.get(urlExif, function(data, status){
			console.debug(status);
			//console.debug(data);
			$(taIv).val(JSON.stringify(data,null,2));
			$(taIv).show();
			$(btnIv).attr('value', '刷新');
		});
	}
	function onSwitchImage() {
		if (!bIvOn) {
			bIvOn = true;
			bPvOn = false;
			bLvOn = false;
			$(imgPv).css({display: 'none'});
			$(imgIv).css({display: 'block'});
			$(imgIv).attr('src', urlIv);
			$(imgPv).attr('src', '');
			$(btnPv).attr('value', '开启');
			$(btnIv).attr('value', '开启中...');
			setTimeout(updateExif(), 2000);
		} else {
			// refresh
			$(imgIv).attr('src', $(imgIv).attr('src').split('?')[0]+'?'+Math.random());
			$(btnIv).attr('value', '刷新中...');
			setTimeout(updateExif(), 2000);
		}

	}

	function onSwitchLiveview() {
		if (!bLvOn) {
			bLvOn = true;
			bIvOn = false;
			bPvOn = false;
			$(imgPv).css({display: 'none'});
			$(imgIv).css({display: 'none'});
			$(imgLv).css({display: 'block'});
			$(imgIv).attr('src', '');
			$(imgPv).attr('src', '');
			$(imgLv).attr('src', urlLv);
			$(btnPv).attr('disabled', 'disabled');
			$(btnIv).attr('disabled', 'disabled');
			$(btnPv).attr('value', '开启');
			$(btnIv).attr('value', '开启');
			$(btnLv).attr('value', '关闭');
            $(taIv).hide();
		} else {
			bLvOn = false;
			$(imgLv).css({display: 'none'});
			$(imgLv).attr('src', '');
			$(btnPv).removeAttr('disabled');
			$(btnIv).removeAttr('disabled');
			$(btnLv).attr('value', '开启');
			sleep(10000);
			closeLiveView();
		}
	}

  </script>
</html>
