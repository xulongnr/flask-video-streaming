<html>
  <head>
    <title>GPhoto Demo</title>
  </head>
  <body>
    <h2>Live View
    <input disabled='1' id='btnLv' type=button value='开启' onclick="onSwitchLiveview();" title='关闭需要等待3秒钟'>
    </h2>
    <!-- <img id='imgLv' src="{{ url_for('live_view') }}" style="border:1px;width:528px;height:352px"> -->
    <img id='imgLv' src='' style="border:1px;width:528px;height:352px;display:none">   
    <hr>

    <h2>Preview Capture
    <input id='btnPv' type=button value='开启' onclick="onSwitchPreview();">
    </h2>
    <!-- <img id='imgPv' src="{{ url_for('capture_preview') }}?" style="border:1px;width:528px;height:352px"> -->
    <img id='imgPv' src='' style="border:1px;width:528px;height:352px;display:none">
    <hr>

    <h2>Image Capture
    <input id='btnIv' type=button value='开启' onclick="onSwitchImage();">
    <input disabled='1' id='btnEi' type=button value='获取EXIF' onclick="onGetExif();">
    <input style="display: none" id='btnEh' type=button value='隐藏EXIF' onClick="onHideExif();">
    </h2>
    <!-- <img id='imgIv' src="{{ url_for('capture_image') }}?" style="border:1px;width:1728px;height:1152px> -->
    <textarea id='taIv' rows='24' readonly style='width:70%;display:none;margin-bottom:10px'></textarea>
    <!--<img id='imgIv' src='' style="border:1px;width:1728px;height:1152px;display:none">-->
    <img id='imgIv' src='' style="border:1px;width:100%;display:none">
    <hr>

	<h2>Camera Configures
	<input id='btnIv' type=button value='获取' onclick="onGetCameraConfigs();">
	</h2>
	<table>
	<tr>
		<td>ISO</td>
		<td></td>
		<td><select id='cfgISO' value='' style='width:80px' onChange='onChangeISO()'></select></td>
		<td></td>
		<td id='stISO'></td>
	</tr>
	<tr>
		<td>快门</td>
		<td></td>
		<td><select id='cfgShs' value='' style='width:80px' onChange='onChangeShs()'></select></td>
		<td></td>
		<td id='stShs'></td>
	</tr>
	<tr>
		<td>光圈</td>
		<td></td>
		<td><select id='cfgApt' value='' style='width:80px' onChange='onChangeApt()'></select></td>
		<td></td>
		<td id='stApt'></td>
	</tr>
	</table>
	<textarea id='taCfg' rows='70' readonly style='width:70%;display:none;margin-top:10px'></textarea>
  </body>

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script type="text/javascript">
	
	var bLvOn = false;
	var bPvOn = false;
	var bIvOn = false;
	var urlPrefix = window.location.protocol + '//' +window.location.host + '/api';
	var urlLv = urlPrefix + '/live_view?';
	var urlPv = urlPrefix + '/capture_preview?';
	var urlIv = urlPrefix + '/capture_image?';
    var urlExif = urlPrefix + '/exif_image';
	var urlCfgs = urlPrefix + '/configs';
	var urlCfg = urlPrefix + '/config';
	var config = null;

	function sleep(time) {
	    var startTime = new Date().getTime() + parseInt(time, 10);
	    while (new Date().getTime() < startTime) {}
	};

	function closeLiveView() {
		$.ajax({
			url: urlLv,
			type: "DELETE",
			success: function(result) {
			}
   		})
	}

	function onSwitchPreview() {
		
		if (!bPvOn) {
			bPvOn = true;
			bIvOn = false;
			bLvOn = false;
			$(imgIv).css({display: 'none'});
			$(imgPv).css({display: 'block'});
			$(imgPv).attr('src', urlPv);
			$(imgIv).attr('src', '');
			$(btnPv).attr('value', '刷新');
			$(btnIv).attr('value', '开启');
            $(btnEi).attr('disabled', 'disabled');
            $(taIv).hide();
            $(btnEh).hide();
			
		} else {
			// refresh
			$(imgPv).attr('src', $(imgPv).attr('src').split('?')[0]+'?'+Math.random());
		}
		
	}

	function onGetCameraConfigs() {
		$(taCfg).val('');
		$.get(urlCfgs, function(data, status){
			$(taCfg).val(JSON.stringify(data,null,2));
			$(taCfg).show();
			$(stISO).empty();
			$(stApt).empty();
			$(stShs).empty();
			config = data;
			if (config != null) {
				console.assert(config[3].name === 'imgsettings', '不存在imgsettings');
				console.assert(config[4].name === 'capturesettings', '不存在capturesettings');
				$.each(config[3].items, function(key, item) {
					if (item.name == 'iso') {
						$(cfgISO).empty();
						$.each(item.choices, function(id, value) {
							var selected = '';
							if (id == item.choice_index) selected = ' selected';
							$("<option value="+value+selected+">"+value+"</option>").appendTo("#cfgISO");
						});
					}
				});
				$.each(config[4].items, function(key, item) {
					if (item.name == 'aperture') {
						$(cfgApt).empty();
						$.each(item.choices, function(id, value) {
							var selected = '';
							if (id == item.choice_index) selected = ' selected';
							$("<option value="+value+selected+">"+value+"</option>").appendTo("#cfgApt");
						});
					} else if (item.name == 'shutterspeed') {
						$(cfgShs).empty();
						$.each(item.choices, function(id, value) {
							var selected = '';
							if (id == item.choice_index) selected = ' selected';
							$("<option value="+value+selected+">"+value+"</option>").appendTo("#cfgShs");
						});
					}
				});
			}
		});
	}

	function onChangeISO() {
		value = $(cfgISO).val();
		if ('' != value) {
			$.ajax({
				url: urlCfg,
				type: 'PUT',
				contentType: 'application/json',
				data: JSON.stringify({name: 'iso', value: value}),
				success: function(data, status) {
					//console.debug(status);
					//console.debug(data);
					$(stISO).empty();
					$(stISO).append(status+', ');
					$(stISO).append(JSON.stringify(data));
				}
			});
		}
	}

	function onChangeApt() {
		value = $(cfgApt).val();
        if ('' != value) {
            $.ajax({
                url: urlCfg,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({name: 'aperture', value: value}),
                success: function(data, status) {
                    //console.debug(status);
                    //console.debug(data);
                    $(stApt).empty();
                    $(stApt).append(status+', ');
                    $(stApt).append(JSON.stringify(data));
                }
            });
        }
	}

	function onChangeShs() {
		value = $(cfgShs).val();
        if ('' != value) {
            $.ajax({
                url: urlCfg,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({name: 'shutterspeed', value: value}),
                success: function(data, status) {
                    //console.debug(status);
                    //console.debug(data);
                    $(stShs).empty();
                    $(stShs).append(status+', ');
                    $(stShs).append(JSON.stringify(data));
                }
            });
        }
	}

    function onHideExif() {
        $(taIv).hide();
        $(btnEh).hide();
    }
	function onGetExif() {
		//$(taIv).hide();
		$(taIv).val('');
		$.get(urlExif, function(data, status){
			console.debug(status);
			//console.debug(data);
			$(taIv).val(JSON.stringify(data,null,2));
			$(taIv).show();
            $(btnEh).show();
			//sleep(1000);
			//$(btnIv).attr('value', '刷新');
		});
	}
    function updateDelay() {
        //sleep(1000);
        $(btnIv).attr('value', '刷新');
    }
	function onSwitchImage() {
		if (!bIvOn) {
			bIvOn = true;
			bPvOn = false;
			bLvOn = false;
			$(imgPv).css({display: 'none'});
			$(imgIv).css({display: 'block'});
            $(btnEi).removeAttr('disabled');
			$(imgIv).attr('src', urlIv);
			$(imgPv).attr('src', '');
			$(btnPv).attr('value', '开启');
			$(btnIv).attr('value', '开启中...');
			setTimeout('updateDelay()', 2000);
		} else {
			// refresh
			$(imgIv).attr('src', $(imgIv).attr('src').split('?')[0]+'?'+Math.random());
			$(btnIv).attr('value', '刷新中...');
            $(taIv).hide();
			setTimeout('updateDelay()', 2000);
		}

	}

	function onSwitchLiveview() {
		if (!bLvOn) {
			bLvOn = true;
			bIvOn = false;
			bPvOn = false;
			$(imgPv).css({display: 'none'});
			$(imgIv).css({display: 'none'});
			$(imgLv).css({display: 'block'});
			$(imgIv).attr('src', '');
			$(imgPv).attr('src', '');
			$(imgLv).attr('src', urlLv);
			$(btnPv).attr('disabled', 'disabled');
			$(btnIv).attr('disabled', 'disabled');
            $(btnEi).attr('disabled', 'disabled');
			$(btnPv).attr('value', '开启');
			$(btnIv).attr('value', '开启');
			$(btnLv).attr('value', '关闭');
            $(taIv).hide();
            $(btnEh).hide();
		} else {
			bLvOn = false;
			$(imgLv).css({display: 'none'});
			$(imgLv).attr('src', '');
			$(btnPv).removeAttr('disabled');
			$(btnIv).removeAttr('disabled');
			$(btnLv).attr('value', '开启');
			sleep(10000);
			closeLiveView();
		}
	}

  </script>
</html>
